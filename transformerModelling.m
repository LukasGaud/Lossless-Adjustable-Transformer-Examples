clc
clear all
syms E1 A1 B1 C1 D1 E2 A2 B2 C2 D2 c s F1 H1
P1 = [
    s*E1 - A1, 0, -B1, 0, 0, 0;
    0, s*E2 - A2, 0, -B2, 0, 0;
    C1, 0, D1, 0, -1, 0;
    0, C2, 0, D2, 0, -1;
    0, 0, 0, c, -1, 0;
    0, 0, c, 0, 0, -1];

M1 = [
    1, 0, 0, 0, 0, 0;
    0, 1, 0, 0, 0, 0;
    0, 0, 1, 0, -1, 0;
    0, 0, 0, 1, 0, -1;
    0, 0, 0, 0, 1, 0;
    0, 0, 0, 0, 0, 1];
N1 = [
    1, 0, 0, 0, 0, 0;
    0, 1, 0, 0, 0, 0;
    0, 0, 1, 0, 0, 0;
    0, 0, 0, 1, 0, 0;
    0, 0, 0, c, 1, 0;
    0, 0, c, 0, 0, 1];

P2e = M1*P1*N1

M2 = [
    1, 0, 0, -B1/c;
    0, 1, 0, 0;
    0, 0, c, D1;
    0, 0, 0, 1];
N2 = [
    1, 0, 0, 0;
    0, 1, 0, 0;
    0, C2/c, 1/c, D2/c;
    0, 0, 0, 1];
N21 = [
    1, 0, 0, 0;
    0, 1, 0, 0;
    0, 0, 0, 1;
    0, 0, 1, 0];

M2e = [M2, zeros(4,2); zeros(2,4), eye(2)];
N2e = [N2*N21, zeros(4,2); zeros(2,4), eye(2)];

P3e = M2e*P2e*N2e

M3 = [
    1, 0, B1*D2/c/(D1*D2-c^2);
    0, 1, B2/(D1*D2 - c^2);
    0, 0, 1/(D1*D2 - c^2)];
N3 = [
    1, 0, 0;
    0, 1, 0;
    -1/(D1*D2 - c^2)*c*C1, -1/(D1*D2 - c^2)*D1*C2, 1];
M3e = [M3, zeros(3,3); zeros(3,3), eye(3)];
N3e = [N3, zeros(3,3); zeros(3,3), eye(3)];

P4e = M3e*P3e*N3e

M = M3e*M2e*M1;
N = N1*N2e*N3e;

P5e = simplify((D1*D2 - c^2)*M*P1*N)

% Disturbance Case
P1d = [
    s*E1 - A1, 0, -B1, 0, 0, 0, -F1;
    0, s*E2 - A2, 0, -B2, 0, 0, 0;
    C1, 0, D1, 0, -1, 0, H1;
    0, C2, 0, D2, 0, -1, 0;
    0, 0, 0, c, -1, 0, 0;
    0, 0, c, 0, 0, -1, 0];
M1d = M1;
N11d = [N1, zeros(6,1);zeros(1,6), 1];
N12d = [
    1, 0, 0, 0, 0, 0, 0;
    0, 1, 0, 0, 0, 0, 0;
    0, 0, 1, 0, 0, 0, 0;
    0, 0, 0, 1, 0, 0, 0;
    0, 0, 0, 0, 0, 1, 0;
    0, 0, 0, 0, 0, 0, 1;
    0, 0, 0, 0, 1, 0, 0];
N1d = N11d*N12d;
P2d = M1d*P1d*N1d;

M2d = [M2, zeros(4,2); zeros(2,4), eye(2)];
N21d = [N2*N21, zeros(4,3); zeros(3,4), eye(3)];
N22d = [
    1, 0, 0, 0, 0, 0, 0;
    0, 1, 0, 0, 0, 0, 0;
    0, 0, 1, 0, 0, 0, 0;
    0, 0, 0, 0, 1, 0, 0;
    0, 0, 0, 1, 0, 0, 0;
    0, 0, 0, 0, 0, 1, 0;
    0, 0, 0, 0, 0, 0, 1];

N2d = N21d*N22d;
P3d = M2d*P2d*N2d;

M3d = [M3, zeros(3,3); zeros(3,3), eye(3)];
N31d = [N3, [[0; 0; -1/(D1*D2 - c^2)*c*H1], zeros(3, 3)]; zeros(4,3), eye(4)];
N32d = [
    1, 0, 0, 0, 0, 0, 0;
    0, 1, 0, 0, 0, 0, 0;
    0, 0, 0, 1, 0, 0, 0;
    0, 0, 1, 0, 0, 0, 0;
    0, 0, 0, 0, 1, 0, 0;
    0, 0, 0, 0, 0, 1, 0;
    0, 0, 0, 0, 0, 0, 1];
N3d = N31d*N32d;
P4d = M3d*P3d*N3d;

Md = M3d*M2d*M1d;
Nd = N1d*N2d*N3d;
P5d = simplify((D1*D2 - c^2)*Md*P1d*Nd);

